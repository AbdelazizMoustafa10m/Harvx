name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  go-ci:
    name: Go Vet/Test/Build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Detect Go project state
        id: detect
        run: |
          set -euo pipefail

          has_go_mod=false
          has_go_files=false
          has_cmd_entrypoint=false

          if [[ -f go.mod ]]; then
            has_go_mod=true
          fi

          go_file_count="$(find . -type f -name '*.go' -not -path './vendor/*' | wc -l | tr -d ' ')"
          if [[ "${go_file_count}" != "0" ]]; then
            has_go_files=true
          fi

          if [[ -f cmd/harvx/main.go ]]; then
            has_cmd_entrypoint=true
          fi

          echo "has_go_mod=${has_go_mod}" >> "$GITHUB_OUTPUT"
          echo "has_go_files=${has_go_files}" >> "$GITHUB_OUTPUT"
          echo "has_cmd_entrypoint=${has_cmd_entrypoint}" >> "$GITHUB_OUTPUT"
          echo "go_file_count=${go_file_count}" >> "$GITHUB_OUTPUT"

      - name: Skip notice (planning/docs-only state)
        if: steps.detect.outputs.has_go_mod != 'true'
        run: |
          {
            echo "## CI"
            echo "No \`go.mod\` found yet. Skipping Go checks for this run."
            echo "This is expected while the repository is still in planning/bootstrap stage."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Setup Go
        if: steps.detect.outputs.has_go_mod == 'true'
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Verify gofmt formatting
        if: steps.detect.outputs.has_go_mod == 'true' && steps.detect.outputs.has_go_files == 'true'
        run: |
          set -euo pipefail
          mapfile -t go_files < <(find . -type f -name '*.go' -not -path './vendor/*' | sort)
          if [[ "${#go_files[@]}" -eq 0 ]]; then
            exit 0
          fi

          unformatted="$(gofmt -l "${go_files[@]}")"
          if [[ -n "${unformatted}" ]]; then
            echo "::error::The following files are not formatted with gofmt:"
            echo "${unformatted}"
            exit 1
          fi

      - name: Run go vet
        if: steps.detect.outputs.has_go_mod == 'true' && steps.detect.outputs.has_go_files == 'true'
        run: go vet ./...

      - name: Run tests
        if: steps.detect.outputs.has_go_mod == 'true' && steps.detect.outputs.has_go_files == 'true'
        run: go test ./... -race -covermode=atomic -coverprofile=coverage.out

      - name: Verify module hygiene
        if: steps.detect.outputs.has_go_mod == 'true' && steps.detect.outputs.has_go_files == 'true'
        run: |
          set -euo pipefail
          go mod tidy
          if ! git diff --exit-code -- go.mod go.sum; then
            echo "::error::go.mod/go.sum changed after 'go mod tidy'. Commit the tidy changes."
            exit 1
          fi

      - name: Build CLI entrypoint
        if: steps.detect.outputs.has_go_mod == 'true' && steps.detect.outputs.has_cmd_entrypoint == 'true'
        run: go build ./cmd/harvx/

      - name: Upload coverage artifact
        if: always() && steps.detect.outputs.has_go_files == 'true' && hashFiles('coverage.out') != ''
        uses: actions/upload-artifact@v4
        with:
          name: coverage.out
          path: coverage.out
          retention-days: 7

  golangci-lint:
    name: golangci-lint
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ hashFiles('go.mod') != '' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Detect Go files
        id: detect
        run: |
          set -euo pipefail
          go_file_count="$(find . -type f -name '*.go' -not -path './vendor/*' | wc -l | tr -d ' ')"
          if [[ "${go_file_count}" != "0" ]]; then
            echo "has_go_files=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_go_files=false" >> "$GITHUB_OUTPUT"
          fi
          echo "go_file_count=${go_file_count}" >> "$GITHUB_OUTPUT"

      - name: Skip lint (no Go files)
        if: steps.detect.outputs.has_go_files != 'true'
        run: echo "No .go files found. Skipping golangci-lint."

      - name: Run golangci-lint
        if: steps.detect.outputs.has_go_files == 'true'
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          args: --timeout=5m

  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [go-ci, golangci-lint]
    if: always()
    steps:
      - name: Check all job results
        run: |
          check_result() {
            local name="$1" result="$2"
            if [[ "$result" != "success" && "$result" != "skipped" ]]; then
              echo "FAIL  $name: $result"
              return 1
            fi
            echo "PASS  $name: $result"
            return 0
          }

          failed=0
          check_result "go-ci" "${{ needs.go-ci.result }}" || failed=1
          check_result "golangci-lint" "${{ needs.golangci-lint.result }}" || failed=1

          if [[ "$failed" -eq 1 ]]; then
            echo "FAIL  CI pipeline failed"
            exit 1
          fi
          echo "PASS  All CI checks passed"
