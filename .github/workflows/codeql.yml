name: CodeQL

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 4 * * 1"
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze-actions:
    name: Analyze (actions)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: ${{ github.event.repository.visibility == 'public' || vars.ENABLE_GHAS_WORKFLOWS == 'true' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: actions
          build-mode: none

      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: /language:actions

  analyze-go:
    name: Analyze (go)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ (github.event.repository.visibility == 'public' || vars.ENABLE_GHAS_WORKFLOWS == 'true') && hashFiles('go.mod') != '' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: go
          build-mode: autobuild

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: /language:go

  codeql-status:
    name: CodeQL Status
    runs-on: ubuntu-latest
    if: always()
    needs: [analyze-actions, analyze-go]
    steps:
      - name: Check all job results
        run: |
          check_result() {
            local name="$1" result="$2"
            if [[ "$result" != "success" && "$result" != "skipped" ]]; then
              echo "FAIL  $name: $result"
              return 1
            fi
            echo "PASS  $name: $result"
            return 0
          }

          failed=0
          check_result "analyze-actions" "${{ needs.analyze-actions.result }}" || failed=1
          check_result "analyze-go" "${{ needs.analyze-go.result }}" || failed=1

          if [[ "$failed" -eq 1 ]]; then
            echo "FAIL  CodeQL workflow failed"
            exit 1
          fi
          echo "PASS  CodeQL checks passed"
